<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Dataset D√ºzenleyici ‚Äì Lojistik Optimizasyonu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --glass-bg: color-mix(in oklab, var(--bs-body-bg) 70%, transparent);
      --glass-bd: color-mix(in oklab, var(--bs-body-color) 15%, transparent);
    }
    body{
      background: radial-gradient(1200px 800px at 10% -10%, rgba(13,110,253,.08), transparent 40%),
                  radial-gradient(800px 800px at 120% 20%, rgba(111,66,193,.10), transparent 35%),
                  var(--bs-body-bg);
      min-height: 100dvh;
    }
    .glass{ background: var(--glass-bg); backdrop-filter: saturate(1.2) blur(6px); -webkit-backdrop-filter: saturate(1.2) blur(6px); border: 1px solid var(--glass-bd); }
    .shadow-soft{ box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    pre.code{ white-space: pre-wrap; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
    .hero{ background: linear-gradient(135deg, rgba(13,110,253,.12), rgba(111,66,193,.10)); border-bottom: 1px solid var(--bs-border-color); }
    .table thead th{ position: sticky; top: 0; z-index: 1; }
    .table-hover tbody tr:hover{ background-color: color-mix(in oklab, var(--bs-primary) 6%, transparent); }
    .btn-ghost{ background: transparent; border: 1px solid var(--bs-border-color); }
    .btn-ghost:hover{ background: color-mix(in oklab, var(--bs-primary) 10%, transparent); }
    .footnote{ font-size: .875rem; color: var(--bs-secondary-color); }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
    .form-section-title{ display:flex; align-items:center; gap:.5rem; margin-bottom:.25rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-md sticky-top glass shadow-soft">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <i class="bi bi-arrow-left-short"></i>
        <span class="fw-semibold">Geri: Ana Sayfa</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-ghost" id="themeToggle" type="button" aria-label="Tema deƒüi≈ütir">
          <i class="bi bi-sun-fill d-none" id="iconSun"></i>
          <i class="bi bi-moon-stars-fill" id="iconMoon"></i>
        </button>
      </div>
    </div>
  </nav>

  <header class="hero">
    <div class="container py-4">
      <h1 class="h4 mb-0">Dataset D√ºzenleyici</h1>
      <p class="text-secondary mb-0">Bu sayfada d√ºzenleyip <b>Kaydet</b> dersen, sunucudaki <code>dataset.json</code> g√ºncellenir ve t√ºm sisteme yansƒ±r.</p>
    </div>
  </header>

  <main class="container my-4">
    <div class="row g-4">
      <div class="col-12 col-lg-8">
        <div class="card glass shadow-soft border-0 rounded-4">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="h6 mb-0">üîß Model Girdileri (D√ºzenlenebilir)</h3>
              <div class="d-flex gap-2 flex-wrap">
                <button id="reloadBtn" class="btn btn-sm btn-outline-secondary">Yeniden Y√ºkle</button>
                <button id="downloadBtn" class="btn btn-sm btn-outline-primary">JSON‚Äôu indir</button>
                <button id="saveBtn" class="btn btn-sm btn-success">Kaydet</button>
                <button id="saveBackBtn" class="btn btn-sm btn-warning">Kaydet ve Ana Sayfaya D√∂n</button>
              </div>
            </div>

            <div class="mb-3">
              <div class="form-section-title">
                <label for="cities" class="form-label mb-0">≈ûehirler (JSON dizi)</label>
              </div>
              <input id="cities" class="form-control" placeholder='["ƒ∞stanbul","Ankara","ƒ∞zmir"]' />
              <div class="form-text">Ara√ß ba≈ülangƒ±√ß konumlarƒ± bu listedeki ≈üehirlerden se√ßilir.</div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-12 col-md-6">
                <label for="main_depot" class="form-label">Ana Depo</label>
                <input id="main_depot" class="form-control" placeholder="ƒ∞stanbul" />
              </div>
              <div class="col-12 col-md-6">
                <label for="periods" class="form-label">D√∂nem Sayƒ±sƒ± (t=1..N)</label>
                <input id="periods" type="number" min="1" class="form-control" placeholder="6" />
              </div>
            </div>

            <div class="mb-3">
              <label for="vehicle_types" class="form-label">Ara√ß Tipleri (JSON)</label>
              <textarea id="vehicle_types" class="form-control" rows="6" placeholder='{"K√º√ß√ºk": {...}}'></textarea>
            </div>

            <div class="mb-3">
              <label for="vehicle_count" class="form-label">Ara√ß Sayƒ±larƒ± (JSON)</label>
              <textarea id="vehicle_count" class="form-control" rows="4" placeholder='{"K√º√ß√ºk": 2, "Orta": 1}'></textarea>
              <div class="form-text">Ara√ß listesi bu alandan t√ºretilir: √∂rn. <code>K√º√ß√ºk_1, K√º√ß√ºk_2, Orta_1</code>.</div>
            </div>

            <!-- Dinamik: Ara√ß Ba≈ülangƒ±√ß Konumlarƒ± -->
            <div class="mb-4">
              <div class="d-flex align-items-center justify-content-between">
                <label class="form-label mb-0">Ara√ß Ba≈ülangƒ±√ß Konumlarƒ±</label>
                <div class="d-flex gap-2">
                  <button id="fillDepotBtn" type="button" class="btn btn-sm btn-outline-secondary">Hepsini Ana Depo Yap</button>
                  <button id="rebuildVehiclesBtn" type="button" class="btn btn-sm btn-outline-primary">Ara√ß Listesini Yenile</button>
                </div>
              </div>
              <div id="vehicleLocWrap" class="table-responsive mt-2"></div>
              <div class="form-text">Her aracƒ±n ba≈ülangƒ±√ß ≈üehrini se√ßin. Belirtilmeyenler kayƒ±tta otomatik ana depoya √ßekilir.</div>
            </div>

            <!-- Kullanƒ±cƒ± dostu Paket Formu -->
            <div class="mb-3">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="form-section-title mb-0">
                  <i class="bi bi-box-seam"></i>
                  <span class="form-label mb-0">Paketler</span>
                </div>
                <div class="d-flex gap-2">
                  <button id="addPackageBtn" type="button" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Paket Ekle
                  </button>

                  <!-- Fotoƒüraftan paket √ßƒ±karma -->
                  <input id="photoInput" type="file" accept="image/*" capture="environment" class="d-none" />
                  <button id="photoBtn" type="button" class="btn btn-sm btn-dark">
                    <i class="bi bi-camera-fill me-1"></i>Fotoƒüraftan Ekle
                  </button>
                </div>
              </div>

              <div id="packagesFormWrap" class="table-responsive mt-2">
                <table class="table table-sm table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:80px">ID</th>
                      <th style="min-width:160px">Ba≈ülangƒ±√ß</th>
                      <th style="min-width:160px">Hedef</th>
                      <th style="min-width:120px">Aƒüƒ±rlƒ±k (kg)</th>
                      <th style="min-width:120px">Ready (t)</th>
                      <th style="min-width:140px">Termin s√ºresi (t)</th>
                      <th style="min-width:120px">Ceza (TL/t)</th>
                      <th style="width:40px"></th>
                    </tr>
                  </thead>
                  <tbody id="packagesTbody">
                    <!-- Satƒ±rlar JS ile -->
                  </tbody>
                </table>
                <div class="form-text mt-1">≈ûehirler dropdown‚Äôdan gelir. T√ºm alanlar zorunludur.</div>
              </div>

              <!-- Eski JSON alanƒ±: artƒ±k otomatik senkron. Gizli tutuyoruz ama indirme/√∂nizleme i√ßin kullanacaƒüƒ±z. -->
              <textarea id="packages" class="form-control d-none" rows="7" placeholder='[{"id":"P1", ...}]'></textarea>
            </div>

            <div class="mb-3">
              <label for="distances" class="form-label">Mesafeler (liste; [i, j, km])</label>
              <textarea id="distances" class="form-control" rows="5" placeholder='[["ƒ∞stanbul","Ankara",450], ...]'></textarea>
            </div>

            <div class="mb-3 col-12 col-md-6">
              <label for="minutil_penalty" class="form-label">Min. Doluluk Ceza (TL/kg)</label>
              <input id="minutil_penalty" class="form-control" type="number" step="0.01" placeholder="10.0" />
            </div>

            <div class="mt-3">
              <div id="status" class="text-secondary small"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- √ñnizleme -->
      <div class="col-12 col-lg-4">
        <div class="card glass shadow-soft border-0 rounded-4">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h3 class="h6 mb-0">√ñnizleme</h3>
              <button class="btn btn-sm btn-outline-primary" type="button" id="refreshPreviewBtn">Yenile</button>
            </div>
            <pre class="code bg-dark text-light rounded p-3 mb-0" id="preview"></pre>
          </div>
        </div>
        <p class="footnote mt-2">Kaydet dediƒüinde sunucudaki <code>dataset.json</code> g√ºncellenir. Ardƒ±ndan ana sayfada ‚ÄúYeniden Y√ºkle‚Äù ile g√∂rebilirsin.</p>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const $ = (id) => document.getElementById(id);

  function setStatus(msg, type="secondary"){ const s=$("status"); if(s) s.innerHTML=`<span class="text-${type}">${msg}</span>`; }

  function parseJSONField(id, name){
    try{ return JSON.parse($(id).value); }catch(e){ throw new Error(`${name} ge√ßerli JSON olmalƒ±: ${e.message}`); }
  }

  // Ara√ß ID listesi √ºret: {"K√º√ß√ºk":2,"Orta":1} -> ["K√º√ß√ºk_1","K√º√ß√ºk_2","Orta_1"]
  function makeVehicleIds(vehicle_count){
    const out = [];
    for(const [typ, cnt] of Object.entries(vehicle_count||{})){
      const n = parseInt(cnt,10) || 0;
      for(let i=1;i<=n;i++) out.push(`${typ}_${i}`);
    }
    return out;
  }

  // ====== Paket Form Durumu ======
  const pkgState = {
    items: [] // {id, baslangic, hedef, agirlik, ready, deadline_suresi, ceza}
  };

  function getCities(){
    try{ return JSON.parse($("cities").value)||[]; }catch(_){ return []; }
  }

  function nextPackageId(){
    // P1..Pn ≈üeklinde artan √∂neri
    const ids = new Set(pkgState.items.map(p=>String(p.id)));
    let i=1; while(ids.has("P"+i)) i++;
    return "P"+i;
  }

  function pkgRowTemplate(p, cities){
    const opts = (cities||[]).map(c=>`<option value="${c}">${c}</option>`).join("");
    return `
      <tr data-pid="${p.id}">
        <td>
          <input class="form-control form-control-sm pkg-id" value="${p.id}" aria-label="Paket ID">
        </td>
        <td>
          <select class="form-select form-select-sm pkg-origin" aria-label="Ba≈ülangƒ±√ß">
            ${opts}
          </select>
        </td>
        <td>
          <select class="form-select form-select-sm pkg-dest" aria-label="Hedef">
            ${opts}
          </select>
        </td>
        <td><input type="number" step="0.01" class="form-control form-control-sm pkg-weight" value="${p.agirlik??0}" aria-label="Aƒüƒ±rlƒ±k"></td>
        <td><input type="number" step="1" class="form-control form-control-sm pkg-ready" value="${p.ready??1}" aria-label="Ready"></td>
        <td><input type="number" step="1" class="form-control form-control-sm pkg-deadline" value="${p.deadline_suresi??1}" aria-label="Termin S√ºresi"></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm pkg-penalty" value="${p.ceza??0}" aria-label="Ceza"></td>
        <td class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger pkg-remove" aria-label="Sil">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    `;
  }

  function renderPackageTable(){
    const tb = $("packagesTbody");
    if(!tb) return;
    const cities = getCities();
    tb.innerHTML = pkgState.items.map(p=>pkgRowTemplate(p, cities)).join("") || `<tr><td colspan="8" class="text-secondary">Paket yok. ‚ÄúPaket Ekle‚Äù ile ekleyin.</td></tr>`;
    // Se√ßimler
    for(const row of tb.querySelectorAll("tr[data-pid]")){
      const pid = row.getAttribute("data-pid");
      const item = pkgState.items.find(x=>String(x.id)===String(pid));
      if(!item) continue;
      const origin = row.querySelector(".pkg-origin");
      const dest   = row.querySelector(".pkg-dest");
      if(origin){ origin.value = item.baslangic || cities[0] || ""; }
      if(dest){ dest.value = item.hedef || cities[0] || ""; }
    }
    bindPackageRowEvents();
    syncPackagesTextarea();
  }

  function bindPackageRowEvents(){
    const tb = $("packagesTbody");
    if(!tb) return;

    tb.querySelectorAll(".pkg-remove").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tr = btn.closest("tr[data-pid]");
        if(!tr) return;
        const pid = tr.getAttribute("data-pid");
        pkgState.items = pkgState.items.filter(p=>String(p.id)!==String(pid));
        renderPackageTable();
      });
    });

    tb.querySelectorAll("tr[data-pid]").forEach(tr=>{
      tr.querySelectorAll("input,select").forEach(el=>{
        el.addEventListener("input", ()=>{
          const pid = tr.getAttribute("data-pid");
          const item = pkgState.items.find(p=>String(p.id)===String(pid));
          if(!item) return;
          item.id              = tr.querySelector(".pkg-id")?.value?.trim() || item.id;
          item.baslangic       = tr.querySelector(".pkg-origin")?.value || item.baslangic;
          item.hedef           = tr.querySelector(".pkg-dest")?.value || item.hedef;
          item.agirlik         = parseFloat(tr.querySelector(".pkg-weight")?.value)||0;
          item.ready           = parseInt(tr.querySelector(".pkg-ready")?.value,10)||1;
          item.deadline_suresi = parseInt(tr.querySelector(".pkg-deadline")?.value,10)||1;
          item.ceza            = parseFloat(tr.querySelector(".pkg-penalty")?.value)||0;
          // Satƒ±r data-pid ID deƒüi≈ütiyse g√ºncelle
          if(tr.getAttribute("data-pid") !== item.id){
            tr.setAttribute("data-pid", item.id);
          }
          syncPackagesTextarea();
          refreshPreview();
        });
      });
    });
  }

  function addEmptyPackage(){
    const cities = getCities();
    pkgState.items.push({
      id: nextPackageId(),
      baslangic: cities[0] || "",
      hedef: cities[1] || cities[0] || "",
      agirlik: 0,
      ready: 1,
      deadline_suresi: 1,
      ceza: 0
    });
    renderPackageTable();
  }

  function loadPackagesToForm(list){
    // Beklenen liste: [{id, baslangic, hedef, agirlik, ready, deadline_suresi, ceza}]
    const cities = new Set(getCities());
    pkgState.items = (list||[]).map(p=>({
      id: String(p.id),
      baslangic: cities.has(p.baslangic) ? p.baslangic : (Array.from(cities)[0]||""),
      hedef: cities.has(p.hedef) ? p.hedef : (Array.from(cities)[0]||""),
      agirlik: Number(p.agirlik)||0,
      ready: parseInt(p.ready,10)||1,
      deadline_suresi: parseInt(p.deadline_suresi,10)||1,
      ceza: Number(p.ceza)||0
    }));
    renderPackageTable();
  }

  function syncPackagesTextarea(){
    // Form -> JSON alanƒ±
    const t = $("packages");
    if(!t) return;
    t.value = JSON.stringify(pkgState.items, null, 2);
  }

  // ====== Ara√ß konumlarƒ± tablosu ======
  function renderVehicleLocationsTable(){
    let cities=[], vcount={}, mainDepot="", existing={};
    try{ cities = JSON.parse($("cities").value); }catch(_){}
    try{ vcount = JSON.parse($("vehicle_count").value); }catch(_){}
    mainDepot = $("main_depot").value.trim();
    try{ existing = window.__vehInitLoc || {}; }catch(_){ existing = {}; }

    const vehicles = makeVehicleIds(vcount);
    const wrap = $("vehicleLocWrap");
    if(!wrap){ return; }

    const opts = (cities||[]).map(c=>`<option value="${c}">${c}</option>`).join("");

    let html = `<table class="table table-sm table-hover align-middle mb-0">
      <thead class="table-light"><tr><th style="width:40%">Ara√ß</th><th style="width:60%">Ba≈ülangƒ±√ß ≈ûehri</th></tr></thead><tbody>`;
    if(!vehicles.length){
      html += `<tr><td colspan="2" class="text-secondary">Ara√ß yok. √ñnce ‚ÄúAra√ß Sayƒ±larƒ±‚Äù alanƒ±nƒ± doldurun.</td></tr>`;
    } else {
      for(const v of vehicles){
        const current = existing[v] && (cities||[]).includes(existing[v]) ? existing[v] : (mainDepot || (cities[0]||""));
        html += `<tr>
          <td class="fw-semibold">${v}</td>
          <td>
            <select id="vehloc_${v}" class="form-select form-select-sm">
              ${opts}
            </select>
          </td>
        </tr>`;
      }
    }
    html += `</tbody></table>`;
    wrap.innerHTML = html;

    for(const v of vehicles){
      const sel = $("vehloc_"+v);
      if(sel){
        const val = (existing[v] && cities.includes(existing[v])) ? existing[v] : (mainDepot || (cities[0]||""));
        if(val) sel.value = val;
      }
    }
  }

  function collectVehicleInitialLocations(){
    let vcount={}; try{ vcount = JSON.parse($("vehicle_count").value); }catch(_){}
    const vehicles = makeVehicleIds(vcount);
    const out = {};
    for(const v of vehicles){
      const sel = $("vehloc_"+v);
      if(sel && sel.value) out[v] = sel.value;
    }
    return out;
  }

  function buildJSON(){
    const data = {
      cities: parseJSONField("cities","≈ûehirler"),
      main_depot: $("main_depot").value.trim(),
      periods: parseInt($("periods").value,10),
      vehicle_types: parseJSONField("vehicle_types","Ara√ß Tipleri"),
      vehicle_count: parseJSONField("vehicle_count","Ara√ß Sayƒ±larƒ±"),
      vehicle_initial_locations: collectVehicleInitialLocations(),
      distances: parseJSONField("distances","Mesafeler"),
      // Paketleri kullanƒ±cƒ± dostu formdan al
      packages: JSON.parse($("packages").value || "[]"),
      minutil_penalty: parseFloat($("minutil_penalty").value)
    };
    if(!data.main_depot) throw new Error("Ana Depo bo≈ü olamaz.");
    if(!Number.isFinite(data.periods) || data.periods<1) throw new Error("D√∂nem sayƒ±sƒ± 1 veya daha b√ºy√ºk olmalƒ±.");
    // G√ºvenlik: ≈üehir doƒürulamasƒ± (se√ßilmi≈ü ≈üehir listede yoksa ana depoya √ßek)
    for(const [k,city] of Object.entries(data.vehicle_initial_locations||{})){
      if(!(data.cities||[]).includes(city)) data.vehicle_initial_locations[k] = data.main_depot;
    }
    // Paket ≈üehir doƒürulamasƒ±
    const citySet = new Set(data.cities||[]);
    data.packages = (data.packages||[]).map(p=>{
      const q = {...p};
      if(!citySet.has(q.baslangic)) q.baslangic = data.main_depot;
      if(!citySet.has(q.hedef))     q.hedef     = data.main_depot;
      q.id = String(q.id||"");
      q.agirlik = Number(q.agirlik)||0;
      q.ready = parseInt(q.ready,10)||1;
      q.deadline_suresi = parseInt(q.deadline_suresi,10)||1;
      q.ceza = Number(q.ceza)||0;
      return q;
    });
    return data;
  }

  async function loadDataset(){
    setStatus("Dataset y√ºkleniyor‚Ä¶");
    let data;
    try{
      let res = await fetch("/dataset", { cache:"no-store" });
      if(res.ok){ const js = await res.json(); if(js && js.ok && js.dataset) data = js.dataset; }
      if(!data){
        const res2 = await fetch(`/dataset.json?v=${Date.now()}`, { cache:"no-store" });
        if(!res2.ok) throw new Error("dataset.json okunamadƒ±");
        data = await res2.json();
      }
      $("cities").value = JSON.stringify(data.cities ?? [],  null, 0);
      $("main_depot").value = data.main_depot ?? "";
      $("periods").value = data.periods ?? 1;
      $("vehicle_types").value = JSON.stringify(data.vehicle_types ?? {}, null, 2);
      $("vehicle_count").value = JSON.stringify(data.vehicle_count ?? {}, null, 2);
      $("distances").value = JSON.stringify(data.distances ?? [], null, 2);
      $("minutil_penalty").value = (data.minutil_penalty ?? 10).toString();

      // Ara√ß konumlarƒ± state'i ve tablo
      window.__vehInitLoc = data.vehicle_initial_locations || {};
      renderVehicleLocationsTable();

      // Paketleri forma d√∂k
      loadPackagesToForm(data.packages || []);

      refreshPreview();
      setStatus("Dataset y√ºklendi ‚úîÔ∏è", "success");
    }catch(err){
      console.error(err);
      setStatus("Dataset y√ºklenemedi: "+err.message, "danger");
    }
  }

  async function saveDataset(redirect=false){
    try{
      const body = JSON.stringify(buildJSON());
      const res = await fetch("/dataset", { method:"PUT", headers:{ "Content-Type":"application/json" }, body });
      if(!res.ok){
        let msg = "Kayƒ±t ba≈üarƒ±sƒ±z";
        try{ const t = await res.json(); msg = t.error || msg; }catch(_){}
        throw new Error(msg + ` (HTTP ${res.status})`);
      }
      setStatus("Dataset kaydedildi ‚úîÔ∏è", "success");
      if(redirect){ setTimeout(()=>{ window.location.href = "index.html"; }, 600); }
    }catch(err){
      console.error(err);
      setStatus("Hata: "+err.message, "danger");
    }
  }

  function refreshPreview(){
    try{ $("preview").textContent = JSON.stringify(buildJSON(), null, 2); }
    catch(e){ $("preview").textContent = "√ñnizleme derlenemedi:\n"+e.message; }
  }

  // ====== Fotoƒüraftan paket √ßƒ±karma ======
  async function extractPackagesFromPhoto(file){
    if(!file) return;
    try{
      setStatus("Fotoƒüraf analiz ediliyor‚Ä¶", "info");
      const fd = new FormData();
      fd.append("image", file, file.name || "image.jpg");
      // ƒ∞steƒüe baƒülƒ±: kullanƒ±cƒ± baƒülamƒ±nƒ± da g√∂nder
      try{
        const ctx = buildJSON();
        fd.append("context", new Blob([JSON.stringify({ cities: ctx.cities })], {type: "application/json"}));
      }catch(_){}

      const res = await fetch("/vision/package-extract", { method:"POST", body: fd });
      const raw = await res.text();
      if(!(res.headers.get("content-type")||"").includes("application/json")) throw new Error("Beklenmeyen yanƒ±t: "+raw.slice(0,200));
      const data = JSON.parse(raw);
      if(!res.ok || data.ok===false) throw new Error(data.error || "G√∂rselden okuma ba≈üarƒ±sƒ±z.");

      const list = Array.isArray(data.packages) ? data.packages : [];
      if(!list.length){ setStatus("Fotoƒüraftan paket bulunamadƒ±.", "warning"); return; }

      // Gelen paketleri uygun ≈üehir doƒürulamasƒ± ile ekle
      const citySet = new Set(getCities());
      for(const p of list){
        const np = {
          id: String(p.id || nextPackageId()),
          baslangic: citySet.has(p.baslangic) ? p.baslangic : ($("main_depot").value.trim() || Array.from(citySet)[0] || ""),
          hedef:     citySet.has(p.hedef)     ? p.hedef     : ($("main_depot").value.trim() || Array.from(citySet)[0] || ""),
          agirlik: Number(p.agirlik)||0,
          ready: parseInt(p.ready,10)||1,
          deadline_suresi: parseInt(p.deadline_suresi,10)||1,
          ceza: Number(p.ceza)||0
        };
        // ID √ßakƒ±≈üƒ±yorsa yeni ID √∂ner
        if(pkgState.items.some(x=>String(x.id)===np.id)){ np.id = nextPackageId(); }
        pkgState.items.push(np);
      }
      renderPackageTable();
      refreshPreview();
      setStatus(`Fotoƒüraftan ${list.length} paket eklendi ‚úîÔ∏è`, "success");
    }catch(err){
      console.error(err);
      setStatus("Fotoƒüraftan ekleme hatasƒ±: "+err.message, "danger");
    }
  }

  // UI eventleri
  $("reloadBtn")?.addEventListener("click", loadDataset);
  $("refreshPreviewBtn")?.addEventListener("click", refreshPreview);
  $("saveBtn")?.addEventListener("click", ()=> saveDataset(false));
  $("saveBackBtn")?.addEventListener("click", ()=> saveDataset(true));
  $("downloadBtn")?.addEventListener("click", ()=>{
    try{
      const json = JSON.stringify(buildJSON(), null, 2);
      const blob = new Blob([json], { type:"application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="dataset.json";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setStatus("JSON indirildi (dataset.json).", "success");
    }catch(e){ setStatus("JSON indirilemedi: "+e.message, "danger"); }
  });

  // Paket Ekle
  $("addPackageBtn")?.addEventListener("click", addEmptyPackage);

  // Fotoƒüraftan Ekle
  $("photoBtn")?.addEventListener("click", ()=> $("photoInput")?.click());
  $("photoInput")?.addEventListener("change", (e)=> extractPackagesFromPhoto(e.target.files?.[0]));

  // Ara√ß listesi deƒüi≈ütiƒüinde konum se√ßimlerini yeniden √ºret
  $("vehicle_count")?.addEventListener("input", ()=>{
    try{ window.__vehInitLoc = collectVehicleInitialLocations(); }catch(_){}
    renderVehicleLocationsTable();
  });
  // ≈ûehir listesi ya da ana depo deƒüi≈üince se√ßenekleri/varsayƒ±lanlarƒ± g√ºncelle
  $("cities")?.addEventListener("input", ()=>{
    renderVehicleLocationsTable();
    // ≈ûehirler deƒüi≈ütiyse paket dropdownlarƒ±nƒ± da g√ºncelle
    renderPackageTable();
    refreshPreview();
  });
  $("main_depot")?.addEventListener("input", renderVehicleLocationsTable);

  // Hepsini ana depoya set et
  $("fillDepotBtn")?.addEventListener("click", ()=>{
    const depot = $("main_depot").value.trim();
    let vcount={}; try{ vcount = JSON.parse($("vehicle_count").value); }catch(_){}
    const vehicles = makeVehicleIds(vcount);
    for(const v of vehicles){
      const sel = $("vehloc_"+v);
      if(sel && depot) sel.value = depot;
    }
    window.__vehInitLoc = collectVehicleInitialLocations();
    refreshPreview();
  });

  // Ara√ß listesini elle yenile (buton)
  $("rebuildVehiclesBtn")?.addEventListener("click", ()=>{
    try{ window.__vehInitLoc = collectVehicleInitialLocations(); }catch(_){}
    renderVehicleLocationsTable();
    refreshPreview();
  });

  (function(){
    const html=document.documentElement, toggle=document.getElementById("themeToggle"), iconSun=document.getElementById("iconSun"), iconMoon=document.getElementById("iconMoon");
    function apply(theme){ html.setAttribute('data-bs-theme', theme); const isLight=(theme==='light'); iconSun&&iconSun.classList.toggle('d-none',!isLight); iconMoon&&iconMoon.classList.toggle('d-none',isLight); try{localStorage.setItem('ui-theme',theme);}catch(_){}} 
    const saved = (()=>{ try{ return localStorage.getItem('ui-theme'); }catch(_){ return null; } })();
    apply(saved||'light');
    toggle?.addEventListener('click', ()=>{ apply(html.getAttribute('data-bs-theme')==='light'?'dark':'light'); });
  })();

  // ƒ∞lk y√ºklemede dataset‚Äôi getir
  loadDataset();
  </script>
</body>
</html>
